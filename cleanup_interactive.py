#!/usr/bin/env python3
"""
SCRIPT DE NETTOYAGE INTERACTIF ET S√âCURIS√â
=========================================
Script pour nettoyer le projet de mani√®re s√©lective et s√©curis√©e.
Bas√© sur l'analyse compl√®te du projet.

üéØ OBJECTIF: R√©duire la taille du projet de 7.08 GB √† ~2-3 GB
üíæ √âCONOMIE ESTIM√âE: ~1.8 GB

Date: 2025-08-31
"""

import os
import shutil
import json
from pathlib import Path
import time

class ProjectCleaner:
    """Nettoyeur de projet interactif et s√©curis√©"""
    
    def __init__(self):
        self.deleted_files = 0
        self.space_saved = 0
        self.backup_created = False
        
    def get_dir_size(self, path):
        """Calculer la taille d'un dossier"""
        total = 0
        try:
            for root, dirs, files in os.walk(path):
                for file in files:
                    file_path = os.path.join(root, file)
                    if os.path.exists(file_path):
                        total += os.path.getsize(file_path)
        except:
            pass
        return total
    
    def format_size(self, size_bytes):
        """Formater la taille"""
        if size_bytes >= 1024**3:  # GB
            return f"{size_bytes / (1024**3):.2f} GB"
        elif size_bytes >= 1024**2:  # MB
            return f"{size_bytes / (1024**2):.2f} MB"
        else:  # KB
            return f"{size_bytes / 1024:.2f} KB"
    
    def safe_delete(self, path):
        """Suppression s√©curis√©e avec v√©rification"""
        try:
            if os.path.isfile(path):
                size = os.path.getsize(path)
                os.remove(path)
                self.deleted_files += 1
                self.space_saved += size
                print(f"   ‚úÖ Fichier supprim√©: {path} ({self.format_size(size)})")
                return True
            elif os.path.isdir(path):
                size = self.get_dir_size(path)
                shutil.rmtree(path)
                self.deleted_files += 1
                self.space_saved += size
                print(f"   ‚úÖ Dossier supprim√©: {path} ({self.format_size(size)})")
                return True
            else:
                print(f"   ‚ö†Ô∏è  Non trouv√©: {path}")
                return False
        except Exception as e:
            print(f"   ‚ùå Erreur lors de la suppression de {path}: {e}")
            return False
    
    def show_main_menu(self):
        """Afficher le menu principal"""
        print("\n" + "üßπ" * 60)
        print("üßπ  NETTOYAGE INTERACTIF DU PROJET")
        print("üßπ" * 60)
        print()
        print("üìä √âTAT ACTUEL DU PROJET:")
        print(f"   - Taille totale: ~7.08 GB")
        print(f"   - Fichiers totaux: 3,396")
        print(f"   - Espace lib√©rable: ~1.8 GB")
        print()
        print("üéØ OPTIONS DE NETTOYAGE:")
        print()
        print("1Ô∏è‚É£  üî¥ CRITIQUE - Mod√®les quantifi√©s redondants (~1.8 GB)")
        print("    Supprime les dossiers de mod√®les quantifi√©s en double")
        print("    Garde seulement 'quantized_models_all'")
        print()
        print("2Ô∏è‚É£  üü° S√âCURIS√â - Fichiers de test/debug (~30 MB)")
        print("    Supprime test_*.py, debug_*.py, quick_*.py, etc.")
        print()
        print("3Ô∏è‚É£  üü¢ OPTIONNEL - Visualisations excessives (~11 MB)")
        print("    Garde les visualisations essentielles seulement")
        print()
        print("4Ô∏è‚É£  üü¢ LOGS - Fichiers temporaires et logs (~1 MB)")
        print("    Supprime *.log, __pycache__, etc.")
        print()
        print("5Ô∏è‚É£  üöÄ NETTOYAGE COMPLET (Recommand√©)")
        print("    Applique toutes les optimisations ci-dessus")
        print()
        print("6Ô∏è‚É£  üìä Voir le d√©tail de chaque cat√©gorie")
        print("7Ô∏è‚É£  üö™ Quitter sans rien faire")
        print()
    
    def clean_quantized_redundant(self):
        """Nettoyer les mod√®les quantifi√©s redondants"""
        print("\nüî¥ NETTOYAGE - MOD√àLES QUANTIFI√âS REDONDANTS")
        print("-" * 50)
        
        # Dossiers √† supprimer (garder seulement quantized_models_all)
        redundant_dirs = [
            "quantized_models_final",
            "quantized_models_final_optimized", 
            "quantized_models_production",
            "quantized_models_ultra"
        ]
        
        total_size_before = 0
        for dir_name in redundant_dirs:
            if os.path.exists(dir_name):
                size = self.get_dir_size(dir_name)
                total_size_before += size
                print(f"üìÅ {dir_name}: {self.format_size(size)}")
        
        print(f"\nüíæ Espace total √† lib√©rer: {self.format_size(total_size_before)}")
        print(f"‚úÖ Dossier conserv√©: quantized_models_all")
        
        confirm = input(f"\n‚ö†Ô∏è  Confirmez-vous la suppression? (oui/non): ").lower()
        
        if confirm == 'oui':
            print(f"\nüöÄ Suppression en cours...")
            for dir_name in redundant_dirs:
                if os.path.exists(dir_name):
                    self.safe_delete(dir_name)
            
            print(f"‚úÖ Nettoyage termin√©!")
            return True
        else:
            print("‚ùå Op√©ration annul√©e")
            return False
    
    def clean_test_debug_files(self):
        """Nettoyer les fichiers de test/debug"""
        print("\nüü° NETTOYAGE - FICHIERS DE TEST/DEBUG")
        print("-" * 50)
        
        import glob
        
        # Patterns des fichiers √† supprimer
        test_patterns = [
            "test_*.py", "debug_*.py", "quick_*.py", "check_*.py",
            "inspect_*.py", "view_*.py"
        ]
        
        files_to_delete = []
        total_size = 0
        
        for pattern in test_patterns:
            for file_path in glob.glob(pattern):
                if os.path.exists(file_path):
                    size = os.path.getsize(file_path)
                    files_to_delete.append(file_path)
                    total_size += size
                    print(f"üìÑ {file_path}: {self.format_size(size)}")
        
        print(f"\nüìä {len(files_to_delete)} fichiers √† supprimer")
        print(f"üíæ Espace √† lib√©rer: {self.format_size(total_size)}")
        
        if files_to_delete:
            confirm = input(f"\n‚ö†Ô∏è  Confirmez-vous la suppression? (oui/non): ").lower()
            
            if confirm == 'oui':
                print(f"\nüöÄ Suppression en cours...")
                for file_path in files_to_delete:
                    self.safe_delete(file_path)
                print(f"‚úÖ Nettoyage termin√©!")
                return True
            else:
                print("‚ùå Op√©ration annul√©e")
                return False
        else:
            print("‚ÑπÔ∏è  Aucun fichier de test trouv√©")
            return False
    
    def clean_visualizations(self):
        """Nettoyer les visualisations excessives"""
        print("\nüü¢ NETTOYAGE - VISUALISATIONS EXCESSIVES")
        print("-" * 50)
        
        # Visualisations essentielles √† garder
        essential_viz = [
            'complete_training_dashboard.png',
            'dataset_comprehensive_analysis.png',
            'CNN_models_comparison.png',
            'index.html'
        ]
        
        viz_dirs = ['visualizations', 'training_curves', 'confusion_matrices', 'metrics']
        files_to_delete = []
        total_size = 0
        
        for viz_dir in viz_dirs:
            if os.path.exists(viz_dir):
                for root, dirs, files in os.walk(viz_dir):
                    for file in files:
                        file_path = os.path.join(root, file)
                        if not any(essential in file for essential in essential_viz):
                            size = os.path.getsize(file_path)
                            files_to_delete.append(file_path)
                            total_size += size
                            print(f"üìÑ {file_path}: {self.format_size(size)}")
        
        print(f"\nüìä {len(files_to_delete)} fichiers √† supprimer")
        print(f"üíæ Espace √† lib√©rer: {self.format_size(total_size)}")
        print(f"‚úÖ Fichiers conserv√©s: {len(essential_viz)} visualisations essentielles")
        
        if files_to_delete:
            confirm = input(f"\n‚ö†Ô∏è  Confirmez-vous la suppression? (oui/non): ").lower()
            
            if confirm == 'oui':
                print(f"\nüöÄ Suppression en cours...")
                for file_path in files_to_delete:
                    self.safe_delete(file_path)
                print(f"‚úÖ Nettoyage termin√©!")
                return True
            else:
                print("‚ùå Op√©ration annul√©e")
                return False
        else:
            print("‚ÑπÔ∏è  Aucune visualisation excessive trouv√©e")
            return False
    
    def clean_logs_temp(self):
        """Nettoyer les logs et fichiers temporaires"""
        print("\nüü¢ NETTOYAGE - LOGS ET TEMPORAIRES")
        print("-" * 50)
        
        import glob
        
        temp_patterns = ["*.log", "*.tmp", "__pycache__", "*.pyc"]
        files_to_delete = []
        total_size = 0
        
        for pattern in temp_patterns:
            if pattern == "__pycache__":
                # Chercher les dossiers __pycache__
                for root, dirs, files in os.walk("."):
                    if "__pycache__" in dirs:
                        pycache_path = os.path.join(root, "__pycache__")
                        size = self.get_dir_size(pycache_path)
                        files_to_delete.append(pycache_path)
                        total_size += size
                        print(f"üìÅ {pycache_path}: {self.format_size(size)}")
            else:
                for file_path in glob.glob(pattern):
                    if os.path.exists(file_path):
                        size = os.path.getsize(file_path)
                        files_to_delete.append(file_path)
                        total_size += size
                        print(f"üìÑ {file_path}: {self.format_size(size)}")
        
        print(f"\nüìä {len(files_to_delete)} √©l√©ments √† supprimer")
        print(f"üíæ Espace √† lib√©rer: {self.format_size(total_size)}")
        
        if files_to_delete:
            confirm = input(f"\n‚ö†Ô∏è  Confirmez-vous la suppression? (oui/non): ").lower()
            
            if confirm == 'oui':
                print(f"\nüöÄ Suppression en cours...")
                for file_path in files_to_delete:
                    self.safe_delete(file_path)
                print(f"‚úÖ Nettoyage termin√©!")
                return True
            else:
                print("‚ùå Op√©ration annul√©e")
                return False
        else:
            print("‚ÑπÔ∏è  Aucun fichier temporaire trouv√©")
            return False
    
    def complete_cleanup(self):
        """Nettoyage complet du projet"""
        print("\nüöÄ NETTOYAGE COMPLET DU PROJET")
        print("=" * 60)
        print("‚ö†Ô∏è  ATTENTION: Cette op√©ration va supprimer:")
        print("   üî¥ Tous les mod√®les quantifi√©s redondants (~1.8 GB)")
        print("   üü° Tous les fichiers de test/debug")
        print("   üü¢ Les visualisations excessives")
        print("   üü¢ Les logs et fichiers temporaires")
        print()
        print("‚úÖ CONSERVERA:")
        print("   üìÅ quantized_models_all/ (mod√®les quantifi√©s optimaux)")
        print("   üìÅ results/ (mod√®les originaux)")
        print("   üìÅ data/ (donn√©es et preprocessing)")
        print("   üìÅ models/ (architectures)")
        print("   üìÅ deployment/ (application web)")
        print("   üìÑ Visualisations essentielles")
        print()
        
        final_confirm = input("ü§î Voulez-vous vraiment proc√©der au nettoyage complet? (OUI/non): ")
        
        if final_confirm.upper() == 'OUI':
            print("\nüöÄ D√âBUT DU NETTOYAGE COMPLET...")
            start_time = time.time()
            
            operations = [
                ("üî¥ Mod√®les quantifi√©s redondants", self.clean_quantized_redundant),
                ("üü° Fichiers de test/debug", self.clean_test_debug_files),
                ("üü¢ Visualisations excessives", self.clean_visualizations),
                ("üü¢ Logs et temporaires", self.clean_logs_temp)
            ]
            
            for operation_name, operation_func in operations:
                print(f"\n{operation_name}...")
                operation_func()
            
            duration = time.time() - start_time
            
            print(f"\n" + "üéâ" * 60)
            print("üéâ  NETTOYAGE COMPLET TERMIN√â!")
            print("üéâ" * 60)
            print(f"üìä Statistiques:")
            print(f"   - √âl√©ments supprim√©s: {self.deleted_files}")
            print(f"   - Espace lib√©r√©: {self.format_size(self.space_saved)}")
            print(f"   - Dur√©e: {duration:.2f} secondes")
            print(f"   - Taille estim√©e finale: ~3-4 GB (vs 7.08 GB initial)")
            
            return True
        else:
            print("‚ùå Nettoyage complet annul√©")
            return False
    
    def show_details(self):
        """Afficher les d√©tails de chaque cat√©gorie"""
        print("\nüìä D√âTAILS DES CAT√âGORIES")
        print("=" * 50)
        
        # Charger le rapport d'analyse s'il existe
        try:
            with open('project_analysis_report.json', 'r', encoding='utf-8') as f:
                report = json.load(f)
            
            print("üìà Statistiques g√©n√©rales:")
            stats = report['project_stats']
            print(f"   - Fichiers totaux: {stats['total_files']:,}")
            print(f"   - Taille totale: {stats['total_size_mb']} MB")
            print(f"   - √âconomie estim√©e: {stats['estimated_savings_mb']} MB")
            
            print("\nüìã R√©partition par cat√©gorie:")
            categories = report['categories_summary']
            for category, count in categories.items():
                print(f"   - {category}: {count} fichiers")
                
        except:
            print("‚ö†Ô∏è  Rapport d'analyse non trouv√©. Ex√©cutez d'abord analyze_project_cleanup.py")
    
    def run(self):
        """Lancer le nettoyeur interactif"""
        
        while True:
            self.show_main_menu()
            
            choice = input("üéØ Choisissez une option (1-7): ").strip()
            
            if choice == '1':
                self.clean_quantized_redundant()
            elif choice == '2':
                self.clean_test_debug_files()
            elif choice == '3':
                self.clean_visualizations()
            elif choice == '4':
                self.clean_logs_temp()
            elif choice == '5':
                self.complete_cleanup()
                break  # Sortir apr√®s nettoyage complet
            elif choice == '6':
                self.show_details()
            elif choice == '7':
                print("\nüëã Au revoir! Aucune modification effectu√©e.")
                break
            else:
                print("\n‚ùå Option invalide. Veuillez choisir entre 1 et 7.")
            
            if choice in ['1', '2', '3', '4']:
                continue_choice = input("\nü§î Voulez-vous continuer le nettoyage? (oui/non): ")
                if continue_choice.lower() != 'oui':
                    break
        
        # R√©sum√© final
        if self.deleted_files > 0:
            print(f"\nüìä R√âSUM√â FINAL:")
            print(f"   ‚úÖ √âl√©ments supprim√©s: {self.deleted_files}")
            print(f"   üíæ Espace lib√©r√©: {self.format_size(self.space_saved)}")
            print(f"   üéØ Votre projet est maintenant plus propre et organis√©!")

def main():
    """Fonction principale"""
    print("üßπ LANCEMENT DU NETTOYEUR DE PROJET")
    print("üéØ Optimisation du projet de classification des maladies du ma√Øs")
    print("=" * 70)
    
    cleaner = ProjectCleaner()
    cleaner.run()

if __name__ == "__main__":
    main()
